name: Korector API Health Monitor

on:
  schedule:
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:

jobs:
  korector-api-health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Korector repository
      uses: actions/checkout@v4

    - name: Set up Python for Korector
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Korector dependencies
      run: |
        pip install requests

    - name: Run Korector health check
      id: health_check
      run: |
        python korector.py --health-check > health_result.json
        cat health_result.json

        if grep -q '"status": "ok"' health_result.json; then
          echo "status=success" >> $GITHUB_OUTPUT
        else:
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Upload Korector health result
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: korector-health-${{ github.run_number }}
        path: health_result.json
        retention-days: 30

    - name: Open issue for Korector API failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const healthResult = fs.readFileSync('health_result.json', 'utf8');

          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Korector API health check failed',
            body: `Korector API health check failed.\n\n\`\`\`json\n${healthResult}\n\`\`\``,
            labels: ['bug', 'korector', 'api-health']
          });
