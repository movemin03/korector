name: API Health Monitor

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 3ì‹œ, ì˜¤í›„ 9ì‹œ (UTC ê¸°ì¤€ 0ì‹œ, 6ì‹œ, 12ì‹œ)
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main ]
    paths:
      - 'korector.py'
      - '.github/workflows/api-monitor.yml'

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests
    
    - name: Run health check
      id: health_check
      run: |
        python korector.py --health-check > health_result.json
        cat health_result.json
        
        # ìƒíƒœ í™•ì¸
        if grep -q '"status": "ok"' health_result.json; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… API is healthy"
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "âŒ API is down"
          exit 1
        fi
    
    - name: Upload health check result
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: health-check-${{ github.run_number }}
        path: health_result.json
        retention-days: 30
    
    - name: Create Issue on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const healthResult = fs.readFileSync('health_result.json', 'utf8');
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Korector API Health Check Failed',
            body: `### API Health Check Failed\n\n**Time:** ${new Date().toISOString()}\n\n**Result:**\n\`\`\`json\n${healthResult}\n\`\`\`\n\n**Action:** Check Naver API status and passportKey extraction logic.`,
            labels: ['bug', 'api-health']
          });
    
    - name: Send notification (optional)
      if: failure()
      run: |
        echo "API health check failed at $(date)" >> $GITHUB_STEP_SUMMARY
        echo "Check the artifacts for details" >> $GITHUB_STEP_SUMMARY
