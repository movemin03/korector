name: Korector Health Monitor

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • (UTC ê¸°ì¤€)
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # ğŸ”´ ì´ìŠˆ ìƒì„± ìœ„í•´ í•„ìš”

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        pip install --upgrade pip
        pip install build setuptools wheel

    - name: Build package
      run: |
        python -m build

    - name: Install Korector (local build)
      run: |
        pip install .

    - name: Run Korector health check
      id: health
      run: |
        python - << 'EOF'
        from korector import NaverSpellChecker
        import json
        import sys

        print("=== Korector Health Check ===")
        try:
            import korector
            print("Version:", getattr(korector, "__version__", "unknown"))
        except Exception as e:
            print("Version: unknown (import error)", e)

        checker = NaverSpellChecker(verbose=False)
        result = checker.health_check()

        print(json.dumps(result, ensure_ascii=False, indent=2))

        # ê²°ê³¼ë¥¼ GitHub Actions ì¶œë ¥ ê°’ìœ¼ë¡œ ì „ë‹¬
        ok = result.get("status") == "ok"
        print(f"::set-output name=status::{result.get('status')}")
        if not ok:
            sys.exit(1)
        EOF

    # ğŸ”¹ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì´ìŠˆ ìƒì„±
    - name: Create issue on failure
      if: failure()  # ìœ„ step ì¤‘ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì‹¤í–‰
      uses: actions/github-script@v7
      with:
        script: |
          const now = new Date().toISOString();
          const sha = context.sha;
          const repoFull = context.repo.owner + '/' + context.repo.repo;

          const title = `ğŸš¨ Korector Health Check Failed (${sha.slice(0,7)})`;
          const body =
            `### ğŸš¨ Korector Health Check Failed\n\n` +
            `**â° Time:** ${now}\n` +
            `**ğŸ”¢ Commit:** ${sha}\n` +
            `**ğŸ“‚ Repository:** ${repoFull}\n\n` +
            `#### Reproduction\n` +
            `\`\`\`bash\n` +
            `git clone https://github.com/${repoFull}.git\n` +
            `cd ${context.repo.repo}\n` +
            `git checkout ${sha}\n` +
            `pip install -e .\n` +
            `python -c "from korector import NaverSpellChecker; print(NaverSpellChecker().health_check())"\n` +
            `\`\`\`\n\n` +
            `#### Action Required\n` +
            `- [ ] Check Naver API status\n` +
            `- [ ] Verify korector._refresh_passport_key()\n`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title,
            body,
            labels: ['bug', 'korector-api', 'health-check']
          });
