name: Korector Health Monitor

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • (UTC ê¸°ì¤€)
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # ì´ìŠˆ ìƒì„± ìœ„í•´ í•„ìš”

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        pip install --upgrade pip
        pip install build setuptools wheel

    # ğŸ”¹ 1ë‹¨ê³„: ê¸°ì¡´ ë¹Œë“œë¬¼ ì™„ì „ ì œê±°
    - name: Clean previous builds
      run: |
        rm -rf dist/ build/ *.egg-info/ .eggs/ .pytest_cache/
        pip cache purge
        echo "ğŸ§¹ Cleaned previous builds and pip cache"

    # ğŸ”¹ 2ë‹¨ê³„: ê¸°ì¡´ korector ì™„ì „ ì œê±°
    - name: Uninstall existing Korector
      run: |
        pip uninstall korector -y || true
        pip show korector || echo "âœ… No existing korector found"
        echo "ğŸ—‘ï¸ Removed existing korector (if any)"

    # ğŸ”¹ 3ë‹¨ê³„: ìƒˆë¡œ ë¹Œë“œ
    - name: Build package (1.0.5)
      run: |
        python -m build
        echo "ğŸ—ï¸ Built korector $(ls -la dist/ | tail -1 | awk '{print $9 " (" $5 " bytes)"}')"
        echo "ğŸ“¦ Built packages:"
        ls -la dist/

    # ğŸ”¹ 4ë‹¨ê³„: í´ë¦° ì„¤ì¹˜
    - name: Clean install Korector (1.0.5)
      run: |
        pip install .
        pip show korector
        echo "âœ… Installed korector 1.0.5 from local build"

    - name: Run Korector health check
      id: health
      run: |
        python - << 'EOF'
        from korector import NaverSpellChecker
        import json
        import sys

        print("=== Korector Health Check (1.0.5) ===")
        import korector
        print(f"Version: {korector.__version__}")
        print(f"Location: {korector.__file__}")

        checker = NaverSpellChecker(verbose=False)
        result = checker.health_check()

        print(json.dumps(result, ensure_ascii=False, indent=2))

        if result.get("status") != "ok":
            print("âŒ HEALTH CHECK FAILED!")
            sys.exit(1)
        print("âœ… HEALTH CHECK PASSED!")
        EOF

    # ğŸ”¹ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì´ìŠˆ ìƒì„±
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const now = new Date().toISOString();
          const sha = context.sha;
          const repoFull = context.repo.owner + '/' + context.repo.repo;

          const title = `ğŸš¨ Korector Health Check Failed (${sha.slice(0,7)})`;
          const body =
            `### ğŸš¨ Korector API Health Check Failed\n\n` +
            `**â° Time:** ${now}\n` +
            `**ğŸ”¢ Commit:** ${sha}\n` +
            `**ğŸ“‚ Repository:** ${repoFull}\n\n` +
            `#### Reproduction\n` +
            `\`\`\`bash\n` +
            `git clone https://github.com/${repoFull}.git\n` +
            `git checkout ${sha}\n` +
            `pip uninstall korector -y\n` +
            `pip install -e .\n` +
            `python -c "from korector import NaverSpellChecker(verbose=False); print(NaverSpellChecker(verbose=False).health_check())"\n` +
            `\`\`\`\n\n` +
            `#### Action Required\n` +
            `- [ ] Check Naver API status\n` +
            `- [ ] Verify korector._refresh_passport_key()\n`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title,
            body,
            labels: ['bug', 'korector-api', 'health-check']
          });
