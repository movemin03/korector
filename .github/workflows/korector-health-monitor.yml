name: Korector Health Monitor

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • (UTC ê¸°ì¤€)
  workflow_dispatch:

permissions:
  contents: read
  issues: write  # ì´ìŠˆ ìƒì„± ìœ„í•´ í•„ìš”

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        pip install --upgrade pip
        pip install build setuptools wheel

    # ğŸ”¹ 1ë‹¨ê³„: ê¸°ì¡´ ë¹Œë“œë¬¼ ì™„ì „ ì œê±°
    - name: Clean previous builds
      run: |
        rm -rf dist/ build/ *.egg-info/ .eggs/ .pytest_cache/
        pip cache purge
        echo "ğŸ§¹ Cleaned previous builds and pip cache"

    # ğŸ”¹ 2ë‹¨ê³„: ê¸°ì¡´ korector ì™„ì „ ì œê±°
    - name: Uninstall existing Korector
      run: |
        pip uninstall korector -y || true
        pip show korector || echo "âœ… No existing korector found"
        echo "ğŸ—‘ï¸ Removed existing korector (if any)"

    # ğŸ”¹ 3ë‹¨ê³„: ìƒˆë¡œ ë¹Œë“œ
    - name: Build package (1.0.6)
      run: |
        python -m build
        echo "ğŸ—ï¸ Built korector $(ls -la dist/ | tail -1 | awk '{print $9 " (" $5 " bytes)"}')"
        echo "ğŸ“¦ Built packages:"
        ls -la dist/

    # ğŸ”¹ 4ë‹¨ê³„: í´ë¦° ì„¤ì¹˜
    - name: Clean install Korector (1.0.6)
      run: |
        pip install .
        pip show korector
        echo "âœ… Installed korector 1.0.6 from local build"

    # ğŸ”¥ğŸ”¥ NEW: ë„¤ì´ë²„ HTML ì™„ì „ ë¶„ì„ (passportKey ìœ„ì¹˜ íŒŒì•…)
    - name: ğŸ” Debug Naver HTML (passportKey ìœ„ì¹˜ í™•ì¸)
      run: |
        python - << 'EOF'
        import requests
        import re
        from collections import Counter
        
        print("ğŸ” ë„¤ì´ë²„ HTML ì™„ì „ ë¶„ì„ (Linux UA)")
        print("=" * 80)
        
        session = requests.Session()
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'ko-KR,ko;q=0.9,en;q=0.8',
            'Accept-Encoding': 'gzip, deflate, br',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
        })
        
        url = 'https://search.naver.com/search.naver?where=nexearch&query=ë„¤ì´ë²„+ë§ì¶¤ë²•+ê²€ì‚¬ê¸°'
        resp = session.get(url, timeout=15)
        
        print(f"âœ… HTTP Status: {resp.status_code}")
        print(f"ğŸ“ Content-Length: {len(resp.text):,} bytes")
        print(f"ğŸ“„ Content-Type: {resp.headers.get('content-type', 'unknown')}")
        
        # 1ï¸âƒ£ ê¸°ì¡´ íŒ¨í„´ë“¤ í…ŒìŠ¤íŠ¸
        patterns = [
            r'checker:\s*"https://ts-proxy\.naver\.com/ocontent/util/SpellerProxy\?passportKey=([a-f0-9]{40})"',
            r'passportKey["\']?\s*[:=]\s*["\']([a-f0-9]{40})',
            r'"passportKey["\']\s*:\s*["\']([a-f0-9]{40})',
            r'passportKey["\']\s*=\s*["\']([a-f0-9]{40})',
            r'SpellerProxy[^>]*passportKey["\']?\s*[:=]\s*["\']([a-f0-9]{40})',
            r'url["\']\s*:\s*["\']https://ts-proxy[^"]*passportKey=([a-f0-9]{40})',
        ]
        
        print("\nğŸ“‹ íŒ¨í„´ ë§¤ì¹˜ ê²°ê³¼:")
        print("-" * 50)
        for i, pattern in enumerate(patterns, 1):
            matches = re.findall(pattern, resp.text, re.IGNORECASE)
            status = f"âœ… {len(matches)}ê°œ" if matches else "âŒ ì—†ìŒ"
            if matches:
                print(f"  {i}. {status}: {matches[0][:16]}...")
            else:
                print(f"  {i}. {status}")
        
        # 2ï¸âƒ£ ëª¨ë“  40ì hex ë¹ˆë„ ë¶„ì„
        all_hex = re.findall(r'[a-f0-9]{40}', resp.text)
        print(f"\nğŸ”¢ 40ì hex ë¬¸ìì—´: {len(all_hex)}ê°œ")
        if all_hex:
            top_keys = Counter(all_hex).most_common(3)
            for i, (key, count) in enumerate(top_keys, 1):
                print(f"  Top {i}: {key[:16]}... (x{count})")
        
        # 3ï¸âƒ£ SpellerProxy ì£¼ë³€ 1000ì
        speller_pos = resp.text.lower().find('spellerproxy')
        if speller_pos != -1:
            snippet_start = max(0, speller_pos - 500)
            snippet_end = min(len(resp.text), speller_pos + 500)
            snippet = resp.text[snippet_start:snippet_end]
            print(f"\nğŸ“„ SpellerProxy ì£¼ë³€ 1000ì:")
            print("-" * 50)
            print(repr(snippet[:500])[1:-1])  # ì²« 500ìë§Œ
            print("..." if len(snippet) > 500 else "")
        else:
            print("\nâŒ 'SpellerProxy' ë¬¸ìì—´ ì—†ìŒ")
        
        # 4ï¸âƒ£ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ë‚´ ê²€ìƒ‰
        scripts = re.findall(r'<script[^>]*>(.*?)</script>', resp.text, re.DOTALL | re.IGNORECASE)
        print(f"\nğŸ“œ Script íƒœê·¸: {len(scripts)}ê°œ")
        for i, script in enumerate(scripts[:3], 1):  # ì²˜ìŒ 3ê°œë§Œ
            hex_in_script = len(re.findall(r'[a-f0-9]{40}', script))
            if hex_in_script > 0:
                print(f"  Script {i}: {hex_in_script}ê°œ hex ë°œê²¬")
        
        EOF

    - name: Run Korector health check
      id: health
      run: |
        python - << 'EOF'
        from korector import NaverSpellChecker
        import json
        import sys

        print("=== Korector Health Check (1.0.6) ===")
        import korector
        print(f"Version: {korector.__version__}")
        print(f"Location: {korector.__file__}")

        checker = NaverSpellChecker(verbose=True)  # ğŸ” ë””ë²„ê¹… ìœ„í•´ verbose=True
        result = checker.health_check()

        print(json.dumps(result, ensure_ascii=False, indent=2))

        if result.get("status") != "ok":
            print("âŒ HEALTH CHECK FAILED!")
            print("ğŸ’¡ ìœ„ ë””ë²„ê¹… ë¡œê·¸ í™•ì¸ í›„ íŒ¨í„´ ì—…ë°ì´íŠ¸ í•„ìš”")
            sys.exit(1)
        print("âœ… HEALTH CHECK PASSED!")
        EOF

    # ğŸ”¹ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ì´ìŠˆ ìƒì„± (ë””ë²„ê¹… ì •ë³´ í¬í•¨)
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const now = new Date().toISOString();
          const sha = context.sha;
          const repoFull = context.repo.owner + '/' + context.repo.repo;

          const title = `ğŸš¨ Korector Health Check Failed (${sha.slice(0,7)})`;
          const body =
            `### ğŸš¨ Korector API Health Check Failed\n\n` +
            `**â° Time:** ${now}\n` +
            `**ğŸ”¢ Commit:** ${sha}\n` +
            `**ğŸ“‚ Repository:** ${repoFull}\n` +
            `**ğŸ–¥ï¸ Platform:** Linux (GitHub Actions)\n\n` +
            `#### ğŸ—ï¸ ë¹Œë“œ/ì„¤ì¹˜ ë¡œê·¸\n` +
            `- Version: 1.0.6\n` +
            `- âœ… ë¡œì»¬ ë¹Œë“œ ì„¤ì¹˜ ì„±ê³µ\n\n` +
            `#### ğŸ” ë””ë²„ê¹… ê²°ê³¼\n` +
            `ìœ„ ì›Œí¬í”Œë¡œìš°ì˜ **"ğŸ” Debug Naver HTML"** ìŠ¤í…ì„ í™•ì¸í•˜ì„¸ìš”!\n` +
            `- SpellerProxy ì£¼ë³€ HTML\n` +
            `- ìƒˆë¡œìš´ passportKey íŒ¨í„´\n` +
            `- 40ì hex ë¹ˆë„ ë¶„ì„\n\n` +
            `#### ğŸ”§ Reproduction\n` +
            `\`\`\`bash\n` +
            `git clone https://github.com/${repoFull}.git\n` +
            `git checkout ${sha}\n` +
            `pip uninstall korector -y\n` +
            `pip install -e .\n` +
            `korector --health-check --verbose\n` +
            `\`\`\`\n\n` +
            `#### ğŸ“‹ Action Required\n` +
            `- [ ] **ë””ë²„ê¹… ë¡œê·¸**ì—ì„œ ìƒˆ passportKey íŒ¨í„´ ì°¾ê¸°\n` +
            `- [ ] \`*_get_key_pattern()*` ë©”ì„œë“œ ì—…ë°ì´íŠ¸\n` +
            `- [ ] **1.0.7** ë¦´ë¦¬ìŠ¤\n`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title,
            body,
            labels: ['bug', 'korector-api', 'health-check', 'needs-triage']
          });
