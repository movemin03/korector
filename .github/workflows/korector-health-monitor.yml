name: Korector Health Monitor

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • (UTC ê¸°ì¤€)
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  # ğŸ”„ Windows í…ŒìŠ¤íŠ¸ (ë¡œì»¬ ì„±ê³µ í—¤ë” ì ìš©)
  windows-test:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: ğŸ§¹ Clean & Build (Windows)
      shell: powershell
      run: |
        pip install --upgrade pip build setuptools wheel
        if (Test-Path "dist") { Remove-Item -Recurse -Force dist -ErrorAction SilentlyContinue }
        if (Test-Path "build") { Remove-Item -Recurse -Force build -ErrorAction SilentlyContinue }
        Get-ChildItem -Filter "*.egg-info" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        try { pip uninstall korector -y } catch { }
        python -m build
        pip install .
        pip show korector

    - name: ğŸ” Windows Naver Debug (ë¡œì»¬ ì„±ê³µ í—¤ë”)
      shell: powershell
      env:
        NAVER_QUERY: "ë„¤ì´ë²„ ë§ì¶¤ë²• ê²€ì‚¬ê¸°"
      run: |
        python - << 'EOF'
        import requests
        import re
        print("ğŸ” Windows ë¡œì»¬ ì„±ê³µ í—¤ë”ë¡œ ë„¤ì´ë²„ ë””ë²„ê¹…")
        print("=" * 80)
        
        session = requests.Session()
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36 Edg/143.0.0.0',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
            'Accept-Encoding': 'gzip, deflate, br, zstd',
            'Accept-Language': 'ko,en-US;q=0.9,en;q=0.8',
            'Cache-Control': 'max-age=0',
            'Sec-Ch-Ua': '"Microsoft Edge";v="143", "Chromium";v="143", "Not A(Brand";v="24"',
            'Sec-Ch-Ua-Arch': '"x86"',
            'Sec-Ch-Ua-Bitness': '"64"',
            'Sec-Ch-Ua-Full-Version-List': '"Microsoft Edge";v="143.0.3650.66", "Chromium";v="143.0.7499.41", "Not A(Brand";v="24.0.0.0"',
            'Sec-Ch-Ua-Mobile': '?0',
            'Sec-Ch-Ua-Model': '""',
            'Sec-Ch-Ua-Platform': '"Windows"',
            'Sec-Ch-Ua-Platform-Version': '"19.0.0"',
            'Sec-Ch-Ua-WoW64': '?0',
            'Sec-Fetch-Dest': 'document',
            'Sec-Fetch-Mode': 'navigate',
            'Sec-Fetch-Site': 'same-origin',
            'Sec-Fetch-User': '?1',
            'Upgrade-Insecure-Requests': '1',
            'Referer': 'https://www.naver.com/',
            'DNT': '1',
            'Priority': 'u=0, i',
        })
        
        # ğŸ”‘ ë¡œì»¬ ì„±ê³µ URL ì •í™• ë³µì‚¬
        url = 'https://search.naver.com/search.naver?where=nexearch&sm=top_hty&fbm=0&ie=utf8&query=%EB%84%A4%EC%9D%B4%EB%B2%84+%EB%A7%9E%EC%B6%A4%EB%B2%95+%EA%B2%80%EC%82%AC%EA%B8%B0&ackey=b3lkpta1'
        resp = session.get(url, timeout=15)
        
        print(f"âœ… Status: {resp.status_code}")
        print(f"ğŸ“ Length: {len(resp.text):,} bytes")
        
        # íŒ¨í„´ ë¶„ì„
        patterns = [
            r'passportKey["\']?\s*[:=]\s*["\']([a-f0-9]{40})',
            r'([a-f0-9]{40})\s*["\']?\s*SpellerProxy',
            r'checker[^"]*passportKey["\']?\s*[:=]\s*["\']([a-f0-9]{40})',
        ]
        
        for i, pattern in enumerate(patterns, 1):
            matches = re.findall(pattern, resp.text, re.IGNORECASE)
            if matches:
                print(f"âœ… íŒ¨í„´ {i}: {matches[0][:16]}...")
        
        all_hex = re.findall(r'[a-f0-9]{40}', resp.text)
        print(f"ğŸ”¢ 40ì hex: {len(all_hex)}ê°œ")
        EOF

    - name: ğŸ–¥ï¸ Windows korector --health-check
      shell: powershell
      run: |
        Write-Output "ğŸ–¥ï¸ Windows Platform Test (ë¡œì»¬ í—¤ë”)"
        python -c "from korector import NaverSpellChecker; checker=NaverSpellChecker(verbose=True); print('Windows Python:', checker.health_check())"
        korector --health-check --verbose
        Write-Output "âœ… Windows Test Complete"

  # ğŸ”„ Linux í…ŒìŠ¤íŠ¸
  linux-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: ğŸ§¹ Clean & Build (Linux)
      run: |
        pip install --upgrade pip build setuptools wheel
        rm -rf dist/ build/ *.egg-info/ 2>/dev/null || true
        pip uninstall korector -y 2>/dev/null || true
        python -m build
        pip install .
        pip show korector

    - name: ğŸ§ Linux korector --health-check
      run: |
        echo "ğŸ§ Linux Platform Test"
        python -c "from korector import NaverSpellChecker; checker=NaverSpellChecker(verbose=True); print('Linux Python:', checker.health_check())"
        korector --health-check --verbose

  # ğŸ”„ macOS í…ŒìŠ¤íŠ¸
  macos-test:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
        - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: ğŸ§¹ Clean & Build (macOS)
      run: |
        pip install --upgrade pip build setuptools wheel
        rm -rf dist/ build/ *.egg-info/ 2>/dev/null || true
        pip uninstall korector -y 2>/dev/null || true
        python -m build
        pip install .
        pip show korector

    - name: ğŸ macOS korector --health-check
      run: |
        echo "ğŸ macOS Platform Test"
        python -c "from korector import NaverSpellChecker; checker=NaverSpellChecker(verbose=True); print('macOS Python:', checker.health_check())"
        korector --health-check --verbose

  # ğŸ“Š ì¢…í•© ê²°ê³¼ ë¦¬í¬íŠ¸
  report:
    needs: [windows-test, linux-test, macos-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: ğŸ“Š Multi-Platform Test Report
      run: |
        echo "=== KORECTOR MULTI-PLATFORM RESULTS ==="
        echo "ğŸ–¥ï¸  WINDOWS:  ${{ needs.windows-test.result }}"
        echo "ğŸ§  LINUX:    ${{ needs.linux-test.result }}"
        echo "ğŸ  macOS:    ${{ needs.macos-test.result }}"
        echo ""
        echo "âœ… ALL PASS = ë…¹ìƒ‰ ë¶ˆ!"
        echo "âŒ ANY FAIL = ìë™ Issue ìƒì„±"

    - name: ğŸš¨ Create Issue if ANY platform fails
      if: |
        needs.windows-test.result == 'failure' ||
        needs.linux-test.result == 'failure' ||
        needs.macos-test.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const failedPlatforms = [];
          if ('${{ needs.windows-test.result }}' !== 'success') failedPlatforms.push('ğŸ–¥ï¸ Windows');
          if ('${{ needs.linux-test.result }}' !== 'success') failedPlatforms.push('ğŸ§ Linux');
          if ('${{ needs.macos-test.result }}' !== 'success') failedPlatforms.push('ğŸ macOS');

          const title = `ğŸš¨ Korector Health Check Failed: ${failedPlatforms.join(', ')}`;
          const body = `### ğŸš¨ Korector Multi-Platform Health Check Failed

**Failed Platforms:**
${failedPlatforms.join('\n')}

**Detailed Logs:**
- [ğŸ–¥ï¸ Windows](${{ needs.windows-test.result_url }})
- [ğŸ§ Linux](${{ needs.linux-test.result_url }})
- [ğŸ macOS](${{ needs.macos-test.result_url }})

**Test Commands (in each log):**
\`\`\`
python -c "from korector import NaverSpellChecker(verbose=True); print(NaverSpellChecker(verbose=True).health_check())"
korector --health-check --verbose
\`\`\`

**Windows Special:**
- ë¡œì»¬ ì„±ê³µ í—¤ë”ë¡œ ë„¤ì´ë²„ ë””ë²„ê¹… í¬í•¨
- Chrome/143 + Edge í—¤ë” ì •í™• ë³µì‚¬`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'korector-api', 'health-check', 'multi-platform']
          });
