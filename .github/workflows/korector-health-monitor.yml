name: Korector API Health Monitor

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 3ì‹œ, ì˜¤í›„ 9ì‹œ (UTC ê¸°ì¤€ 0ì‹œ, 6ì‹œ, 12ì‹œ)
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main ]
    paths:
      - 'korector.py'
      - '.github/workflows/korector-health-monitor.yml'

jobs:
  korector-health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Korector repository
      uses: actions/checkout@v4
    
    - name: Set up Python for Korector
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Korector dependencies
      run: |
        pip install requests
    
    - name: Run Korector health check
      id: korector_health
      run: |
        python korector.py --health-check > korector_health_result.json
        cat korector_health_result.json
        
        # Korector API ìƒíƒœ í™•ì¸
        if grep -q '"status": "ok"' korector_health_result.json; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Korector API is healthy"
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "âŒ Korector API is down"
          exit 1
        fi
    
    - name: Upload Korector health check result
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: korector-health-check-${{ github.run_number }}
        path: korector_health_result.json
        retention-days: 30
    
    - name: Create Issue on Korector API Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const healthResult = fs.readFileSync('korector_health_result.json', 'utf8');
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸš¨ Korector API Health Check Failed',
            body: `### Korector API Health Check Failed\n\n**Time:** ${new Date().toISOString()}\n\n**Result:**\n\`\`\`json\n${healthResult}\n\`\`\`\n\n**Action:** Check Naver API status and Korector passportKey extraction logic.`,
            labels: ['bug', 'korector-api', 'health-check']
          });
    
    - name: Summary for Korector health check
      if: always()
      run: |
        if [ "${{ steps.korector_health.outputs.status }}" == "success" ]; then
          echo "### âœ… Korector API Health Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Korector API is functioning normally at $(date)" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Korector API Health Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Korector API health check failed at $(date)" >> $GITHUB_STEP_SUMMARY
          echo "Check the artifacts for detailed error information" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Slack Notification (Optional)
      if: failure()
      run: |
        echo "You can add Slack/Discord notification here"
        echo "Example: Use slackapi/slack-github-action or webhook"
