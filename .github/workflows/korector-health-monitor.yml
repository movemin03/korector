name: Korector Health Monitor

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì • (UTC ê¸°ì¤€)
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  # ğŸ”„ Windows í…ŒìŠ¤íŠ¸
  windows-test:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: ğŸ§¹ Clean & Build (Windows)
      shell: powershell
      run: |
        pip install --upgrade pip build setuptools wheel
        Remove-Item -Recurse -Force dist, build, *.egg-info -ErrorAction SilentlyContinue
        python -m build
        pip install .
        pip show korector

    - name: ğŸ” Windows Naver Debug + korector --health-check (via proxy)
      shell: powershell
      env:
        HTTP_PROXY: http://proxy.geonode.com:8080
        HTTPS_PROXY: http://proxy.geonode.com:8080
      run: |
        Write-Output "HTTP_PROXY=$env:HTTP_PROXY"
        python -c "from korector import NaverSpellChecker; checker=NaverSpellChecker(verbose=True); print('Windows CLI via proxy:', checker.health_check())"
        korector --health-check --verbose

  # ğŸ”„ Linux (Ubuntu) í…ŒìŠ¤íŠ¸  
  linux-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: ğŸ§¹ Clean & Build (Linux)
      run: |
        pip install --upgrade pip build setuptools wheel
        rm -rf dist/ build/ *.egg-info/
        python -m build
        pip install .
        pip show korector

    - name: ğŸ” Linux Naver Debug + korector --health-check (via proxy)
      env:
        HTTP_PROXY: http://proxy.geonode.com:8080
        HTTPS_PROXY: http://proxy.geonode.com:8080
      run: |
        echo "HTTP_PROXY=$HTTP_PROXY"
        python -c "from korector import NaverSpellChecker; checker=NaverSpellChecker(verbose=True); print('Linux CLI via proxy:', checker.health_check())"
        korector --health-check --verbose

  # ğŸ”„ macOS í…ŒìŠ¤íŠ¸ (iOS ë¹„ìŠ·)
  macos-test:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: ğŸ§¹ Clean & Build (macOS)
      run: |
        pip install --upgrade pip build setuptools wheel
        rm -rf dist/ build/ *.egg-info/
        python -m build
        pip install .
        pip show korector

    - name: ğŸ” macOS Naver Debug + korector --health-check (via proxy)
      env:
        HTTP_PROXY: http://proxy.geonode.com:8080
        HTTPS_PROXY: http://proxy.geonode.com:8080
      run: |
        echo "HTTP_PROXY=$HTTP_PROXY"
        python -c "from korector import NaverSpellChecker; checker=NaverSpellChecker(verbose=True); print('macOS CLI via proxy:', checker.health_check())"
        korector --health-check --verbose

  # ğŸ“Š ì¢…í•© ê²°ê³¼ ë¦¬í¬íŠ¸
  report:
    needs: [windows-test, linux-test, macos-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: ğŸ“Š Multi-Platform Test Report
      run: |
        echo "ğŸ–¥ï¸  WINDOWS: ${{ needs.windows-test.result }}"
        echo "ğŸ§  LINUX:   ${{ needs.linux-test.result }}"
        echo "ğŸ  macOS:   ${{ needs.macos-test.result }}"
        echo ""
        if [ "${{ needs.windows-test.result }}" = "success" ] && [ "${{ needs.linux-test.result }}" = "success" ] && [ "${{ needs.macos-test.result }}" = "success" ]; then
          echo "âœ… ALL PASS â†’ ë…¹ìƒ‰ ë¶ˆ!"
        else
          echo "âŒ SOME FAILED â†’ Issue ìë™ ìƒì„±"
        fi

    - name: ğŸš¨ Create Issue if ANY platform fails
      if: |
        needs.windows-test.result == 'failure' ||
        needs.linux-test.result == 'failure' ||
        needs.macos-test.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const results = {
            windows: '${{ needs.windows-test.result }}',
            linux: '${{ needs.linux-test.result }}',
            macos: '${{ needs.macos-test.result }}'
          };
          
          const failed = Object.entries(results)
            .filter(([platform, result]) => result !== 'success')
            .map(([platform, result]) => `âŒ **${platform.toUpperCase()}**: ${result}`)
            .join('\n');

          const title = `ğŸš¨ Korector Multi-Platform Health Check Failed`;
          const body =
            `### ğŸš¨ Korector Multi-Platform Test Failed (with HTTP_PROXY)\n\n` +
            `**â° Time:** ${new Date().toISOString()}\n\n` +
            `${failed}\n\n` +
            `#### ğŸ” Check individual job logs:\n` +
            `- Windows job: windows-test\n` +
            `- Linux job: linux-test\n` +
            `- macOS job: macos-test\n\n` +
            `#### ğŸ§ª korector --health-check Results:\n` +
            `ê° í”Œë«í¼ë³„ ë¡œê·¸ì—ì„œ \`korector --health-check --verbose\` ê²°ê³¼ì™€ í”„ë¡ì‹œ ì ìš© ì—¬ë¶€(HTTP_PROXY ë¼ì¸)ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n\n` +
            `#### ğŸ”§ Next Steps:\n` +
            `- [ ] í”„ë¡ì‹œë¥¼ í†µí•œ ë„¤ì´ë²„ ì ‘ì† ì„±ê³µ ì—¬ë¶€ í™•ì¸\n` +
            `- [ ] ì—¬ì „íˆ passportKey ì‹¤íŒ¨ ì‹œ HTML íŒ¨í„´ ì¶”ê°€ ë¶„ì„\n`;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title,
            body,
            labels: ['bug', 'korector-api', 'health-check', 'multi-platform', 'proxy']
          });
