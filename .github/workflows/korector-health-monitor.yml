name: Korector Health Monitor

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  # üñ•Ô∏è Windows ÌÖåÏä§Ìä∏ (ÏàòÏ†ïÎê®)
  windows-test:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: üßπ Clean & Build (Windows) - FIXED
      shell: powershell
      run: |
        pip install --upgrade pip build setuptools wheel
        
        # ÏïàÏ†ÑÌïú ÎπåÎìúÎ¨º Ï†úÍ±∞
        if (Test-Path "dist") { Remove-Item -Recurse -Force dist }
        if (Test-Path "build") { Remove-Item -Recurse -Force build }
        Get-ChildItem -Filter "*.egg-info" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        
        # ÏïàÏ†ÑÌïú korector Ï†úÍ±∞
        try {
            pip uninstall korector -y
            Write-Output "‚úÖ korector uninstalled"
        } catch {
            Write-Output "‚ÑπÔ∏è korector was not installed (OK)"
        }
        
        # ÎπåÎìú & ÏÑ§Ïπò
        python -m build
        pip install .
        pip show korector | Out-String -Width 1000
        Write-Output "‚úÖ Windows Build Success"

    - name: üñ•Ô∏è Windows korector --health-check
      shell: powershell
      run: |
        Write-Output "üñ•Ô∏è Windows Platform Test"
        python -c "from korector import NaverSpellChecker; c=NaverSpellChecker(verbose=True); r=c.health_check(); print('Python:', r)"
        korector --health-check --verbose
        Write-Output "‚úÖ Windows CLI Test Complete"

  # üêß Linux ÌÖåÏä§Ìä∏
  linux-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: üßπ Clean & Build (Linux)
      run: |
        pip install --upgrade pip build setuptools wheel
        rm -rf dist/ build/ *.egg-info/ || true
        pip uninstall korector -y || true
        python -m build
        pip install .
        pip show korector

    - name: üêß Linux korector --health-check
      run: |
        echo "üêß Linux Platform Test"
        python -c "from korector import NaverSpellChecker; c=NaverSpellChecker(verbose=True); print('Python:', c.health_check())"
        korector --health-check --verbose

  # üçé macOS ÌÖåÏä§Ìä∏
  macos-test:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: üßπ Clean & Build (macOS)
      run: |
        pip install --upgrade pip build setuptools wheel
        rm -rf dist/ build/ *.egg-info/ || true
        pip uninstall korector -y || true
        python -m build
        pip install .
        pip show korector

    - name: üçé macOS korector --health-check
      run: |
        echo "üçé macOS Platform Test"
        python -c "from korector import NaverSpellChecker; c=NaverSpellChecker(verbose=True); print('Python:', c.health_check())"
        korector --health-check --verbose

  # üìä Í≤∞Í≥º Î¶¨Ìè¨Ìä∏
  report:
    needs: [windows-test, linux-test, macos-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: üìä Multi-Platform Summary
      run: |
        echo "
        üñ•Ô∏è  WINDOWS:  ${{ needs.windows-test.result  }} 
        üêß  LINUX:    ${{ needs.linux-test.result    }}
        üçé  macOS:    ${{ needs.macos-test.result    }}
        
        $(if [[ '${{ needs.windows-test.result }}' == 'success' && '${{ needs.linux-test.result }}' == 'success' && '${{ needs.macos-test.result }}' == 'success' ]]; then echo '‚úÖ ALL PLATFORMS PASS!'; else echo '‚ö†Ô∏è  SOME PLATFORMS FAILED'; fi)
        "

    - name: üö® Issue on Failure
      if: contains(fromJSON(needs.*.result), 'failure') || contains(fromJSON(needs.*.result), 'cancelled')
      uses: actions/github-script@v7
      with:
        script: |
          const results = {
            windows: '${{ needs.windows-test.result }}',
            linux: '${{ needs.linux-test.result }}', 
            macos: '${{ needs.macos-test.result }}'
          };
          
          const failedPlatforms = Object.entries(results)
            .filter(([p, r]) => r !== 'success')
            .map(([p, r]) => `‚ùå ${p.toUpperCase()}: ${r}`).join('\n');
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'üö® Korector Multi-Platform Health Check Failed',
            body: `**Failed Platforms:**
\`\`\`
${failedPlatforms}
\`\`\`

**Check logs:**
- Windows: ${{ needs.windows-test.result_url }}
- Linux:   ${{ needs.linux-test.result_url }} 
- macOS:   ${{ needs.macos-test.result_url }}

**CLI Results:** korector --health-check --verbose in each platform log`,
            labels: ['bug', 'health-check', 'multi-platform']
          });
